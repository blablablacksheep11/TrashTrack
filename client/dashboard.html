<!DOCTYPE html>
<html lang="en" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrashTrack</title>
    <link rel="icon" type="image/svg+xml" href="/smart-trash-dark.svg">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/main.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Web Socket -->
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"
        integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+"
        crossorigin="anonymous"></script>
    <!-- Google Chart -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body {
            min-height: 100vh !important;
            position: relative;
        }

        #chart_div {
            border-radius: 0.375rem;
        }

        #graph_div {
            border-radius: 0.375rem;
        }

        #disposal-overview {
            border-radius: 0.375rem;
        }

        #theme::after {
            display: none !important;
        }
    </style>
</head>

<body class="bg-body-tertiary d-flex flex-column">
    <div class="row p-0 m-0" id="navbar">
        <!-- the navigaiton bar will be loaded here -->
    </div>
    <div class="row mt-4 px-4 m-0">
        <div class="col-sm-3 mb-3 mb-sm-0">
            <a class="card h-100 text-decoration-none" role="button" href="bin.html">
                <div class="card-body">
                    <h5 class="card-title">Registered bin</h5>
                    <p class="card-text" id="registeredbincount">Number of registered bin:</p>
                </div>
            </a>
        </div>
        <div class="col-sm-3 mb-3 mb-sm-0">
            <a class="card h-100 text-decoration-none" role="button">
                <div class="card-body">
                    <h5 class="card-title">Free bin</h5>
                    <p class="card-text" id="freebincount">Number of available bin:</p>
                </div>
            </a>
        </div>
        <div class="col-sm-3 mb-3 mb-sm-0">
            <a class="card h-100 text-decoration-none" role="button">
                <div class="card-body">
                    <h5 class="card-title">Fulled bin</h5>
                    <p class="card-text" id="fulledbincount">Number of unavailable bin:</p>
                </div>
            </a>
        </div>
        <div class="col-sm-3">
            <a class="card h-100 text-decoration-none" role="button" href="cleaner.html">
                <div class="card-body">
                    <h5 class="card-title">Cleaner</h5>
                    <p class="card-text" id="cleanercount">Number of cleaner:</p>
                </div>
            </a>
        </div>
    </div>

    <div class="row mt-4 px-4 m-0">
        <div class="col-lg-9">
            <div id="chart_div" class="border d-flex align-items-center justify-content-center bg-white px-3">
                <p class="text-center mt-3">No bin found ...<br><i class="bi bi-trash3 fs-2"></i></p>
            </div>
        </div>
        <div class="col-lg-3 mt-4 mt-lg-0">
            <div id="disposal-overview"
                class="border d-flex align-items-center justify-content-center bg-white px-3 pb-2">
                <p class="text-center mt-3">No bin found ...<br><i class="bi bi-trash3 fs-2"></i></p>
            </div>
        </div>
    </div>
    <div class="row mt-4 px-4 m-0">
        <div class="col-xl-6 mt-3 mt-xl-0">
            <table class="table table-hover border caption-top">
                <caption class="pt-0">List of free bin</caption>
                <thead class="table">
                    <tr>
                        <th scope="col">Bin ID</th>
                        <th scope="col">Location</th>
                        <th scope="col">Paper Accumulation</th>
                        <th scope="col">Plastic Accumulation</th>
                        <th scope="col">General Waste Accumulation</th>
                    </tr>
                </thead>
                <tbody id="freebin-table">
                    <tr>
                        <td colspan="5" class="py-3 text-center">No free bin found ...<br><i
                                class="bi bi-trash3 fs-2"></i></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="col-xl-6 mt-3 mt-xl-0">
            <table class="table table-hover border caption-top">
                <caption class="pt-0">List of fulled bin</caption>
                <thead class="table">
                    <tr>
                        <th scope="col">Bin ID</th>
                        <th scope="col">Location</th>
                        <th scope="col">Paper Accumulation</th>
                        <th scope="col">Plastic Accumulation</th>
                        <th scope="col">General Waste Accumulation</th>
                    </tr>
                </thead>
                <tbody id="fulledbin-table">
                    <tr>
                        <td colspan="5" class="py-3 text-center">No fulled bin found ...<br><i
                                class="bi bi-trash3 fs-2"></i></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="row mt-4 px-4 m-0 mb-5">
        <div class="col">
            <div id="graph_div" class="border d-flex align-items-center justify-content-center bg-white">
                <p class="text-center mt-3">No bin found ...<br><i class="bi bi-trash3 fs-2"></i></p>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <div class="row w-100 p-0 m-0 bg-secondary-subtle d-flex justify-content-center" id="footer"
        style="margin-top: auto !important;">
        <!-- Footer will be loaded here -->
    </div>

    <!-- Google Chart -->
    <script type="text/javascript">
        async function drawChart1(remainingDistance) {
            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(drawC1);
            function drawC1() {
                // Create the data table.
                var data = new google.visualization.DataTable();
                data.addColumn('string', 'Type');
                data.addColumn('number', 'Accumulation');
                data.addRows([
                    ['Free space', remainingDistance],
                    ['Occupied space', 11.5 - remainingDistance]
                ]);

                // Set chart options
                var options = {
                    title: 'Paper',
                    titleTextStyle: {
                        'color': 'grey', // Change the title color to grey
                        'fontSize': 16,  // Optionally adjust the font size
                        'bold': false     // Optionally make the title unbolded
                    },
                    pieHole: 0.7,
                    pieSliceTextStyle: {
                        color: 'black',
                    },
                    colors: ['#E5E7EB', '#5BC0EB'],
                    backgroundColor: 'transparent',
                    pieSliceBorderColor: 'transparent',
                    legend: 'none',
                    width: 300, // Control the canvas width
                    height: 350, // Control the canvas height
                    chartArea: { width: '90%', height: '67.5%' }, // Determine the chart size in canvas
                };

                // Instantiate and draw our chart, passing in some options.
                var chart = new google.visualization.PieChart(document.getElementById('cat1_chart_container'));
                chart.draw(data, options);
            }
        }

        async function drawChart2(remainingDistance) {
            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(drawC2);
            function drawC2() {
                // Create the data table.
                var data = new google.visualization.DataTable();
                data.addColumn('string', 'Type');
                data.addColumn('number', 'Accumulation');
                data.addRows([
                    ['Free space', remainingDistance],
                    ['Occupied space', 11.5 - remainingDistance]
                ]);

                // Set chart options
                var options = {
                    title: 'Plastic',
                    titleTextStyle: {
                        'color': 'grey', // Change the title color to grey
                        'fontSize': 16,  // Optionally adjust the font size
                        'bold': false     // Optionally make the title unbolded
                    },
                    pieHole: 0.7,
                    pieSliceTextStyle: {
                        color: 'black',
                    },
                    colors: ['#E5E7EB', '#FFA94D'],
                    pieSliceBorderColor: 'transparent',
                    backgroundColor: 'transparent',
                    legend: 'none',
                    width: 300, // Control the canvas width
                    height: 350, // Control the canvas height
                    chartArea: { width: '90%', height: '67.5%' }, // Determine the chart size in canvas
                };


                // Instantiate and draw our chart, passing in some options.
                var chart = new google.visualization.PieChart(document.getElementById('cat2_chart_container'));
                chart.draw(data, options);
            }
        }

        async function drawChart3(remainingDistance) {
            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(drawC3);
            function drawC3() {
                // Create the data table.
                var data = new google.visualization.DataTable();
                data.addColumn('string', 'Type');
                data.addColumn('number', 'Accumulation');
                data.addRows([
                    ['Free space', remainingDistance],
                    ['Occupied space', 11.5 - remainingDistance]
                ]);

                // Set chart options
                var options = {
                    title: 'General Waste',
                    titleTextStyle: {
                        'color': 'grey', // Change the title color to grey
                        'fontSize': 16,  // Optionally adjust the font size
                        'bold': false     // Optionally make the title unbolded
                    },
                    pieHole: 0.7,
                    pieSliceTextStyle: {
                        color: 'black',
                    },
                    colors: ['#E5E7EB', '#9BC53D'],
                    backgroundColor: 'transparent',
                    pieSliceBorderColor: 'transparent',
                    legend: 'none',
                    width: 300, // Control the canvas width
                    height: 350, // Control the canvas height
                    chartArea: { width: '90%', height: '67.5%' }, // Determine the chart size in canvas
                };

                // Instantiate and draw our chart, passing in some options.
                var chart = new google.visualization.PieChart(document.getElementById('cat3_chart_container'));
                chart.draw(data, options);
            }
        }

        async function drawColChart() {
            google.charts.load("current", { packages: ["corechart"] });
            google.charts.setOnLoadCallback(drawCC);

            async function drawCC() {

                const response = await fetch(`http://localhost:3000/dashboard/getDisposalOverview`);
                let summary = await response.json();

                const category = [];
                for(let i=0; i < summary.length; i++) {
                    category[i] = Object.values(summary[i]);
                }

                garbageType = [
                    ['Garbage Type', 'Disposal Count', { role: 'style' }],
                   ...category
                ];

                const data = google.visualization.arrayToDataTable(garbageType);

                var options = {
                    title: 'Disposal Overview',
                    legend: { position: 'none' },
                    height: 350,
                    width: 320,
                    chartArea: { width: '75%', height: '67.5%' },
                    backgroundColor: 'transparent',
                    titleTextStyle: { color: 'grey' },
                    legend: { position: 'none' },
                    hAxis: {
                        title: 'Garbage Type',
                        textStyle: {
                            color: 'grey',
                        },
                        titleTextStyle: {
                            color: 'grey',
                        }
                    },
                    vAxis: {
                        textStyle: {
                            color: 'grey'
                        }
                    }
                };

                var chart = new google.visualization.ColumnChart(document.getElementById('disposal-overview'));
                chart.draw(data, options);
            }
        }

        async function drawGraph(binid, dates) {
            document.getElementById("graph_div").classList.add("py-4");
            google.charts.load('current', { 'packages': ['line'] });
            google.charts.setOnLoadCallback(drawG);

            async function drawG() {

                var data = new google.visualization.DataTable();
                data.addColumn('date', 'Date');
                data.addColumn('number', 'Collection Frequency');

                for (const entry of dates) {
                    const response = await fetch(`http://localhost:3000/dashboard/getHistory/${binid}/${entry.date}`);
                    const sum = await response.json();

                    const date = new Date(entry.date);
                    const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

                    data.addRows([
                        [new Date(formattedDate), sum[0].sum]
                    ]);
                }

                var options = {
                    'title': `Collection Frequency of Bin${binid}`,
                    'width': 1300, // Control the canvas width
                    'height': 450, // Control the canvas height
                    'chartArea': { width: '90%', height: '67.5%', 'backgroundColor': 'transparent' }, // Determine the chart size in canvas
                    'tooltip': { isHtml: true },
                    'colors': ['#007bff'],
                    'backgroundColor': 'transparent',
                };

                var chart = new google.charts.Line(document.getElementById('graph_div'));

                chart.draw(data, google.charts.Line.convertOptions(options));
            }
        }
    </script>
    <!-- General JavaScript-->
    <script>
        const socket = io('http://localhost:3000');
        socket.on('connect', (response) => {
            console.log("Connected to server");
        });

        window.onload = async () => {
            await loadNavbar();
            await loadFooter();
            initializeChart();
            initializeGraph();
            loadBinsCount();
            loadCleanerCount();
            loadFreeBinTable();
            loadFulledBinTable();
            drawColChart();
            getTheme();
        }

        async function loadNavbar() {
            const response = await fetch('http://localhost:3000/loadNavbar');
            const data = await response.text();
            document.getElementById("navbar").innerHTML = data;
            document.getElementById("navbar-home-btn").classList.add("active");
        }

        async function loadFooter() {
            const response = await fetch('http://localhost:3000/loadFooter');
            const data = await response.text();
            document.getElementById("footer").innerHTML = data;
        }

        async function loadBinsCount() {
            const response = await fetch("http://localhost:3000/dashboard/loadBinsCount");
            const data = await response.json();
            document.getElementById("registeredbincount").innerHTML = `Number of registered bin: ${data.length}`;
            document.getElementById("freebincount").innerHTML = `Number of available bin: ${(data.filter((bin) => bin.status == "available")).length}`;
            document.getElementById("fulledbincount").innerHTML = `Number of unavailable bin: ${(data.filter((bin) => bin.status == "unavailable")).length}`;
        }

        async function loadCleanerCount() {
            const response = await fetch("http://localhost:3000/dashboard/loadCleanerCount");
            const data = await response.json();
            document.getElementById("cleanercount").innerHTML = `Number of cleaner: ${data.total}`;
        }

        async function loadFreeBinTable() {
            const response = await fetch("http://localhost:3000/dashboard/loadFreeBinTable");
            const data = await response.json();
            const table = document.getElementById("freebin-table");
            if (data.length > 0) {
                table.innerHTML = "";
                data.forEach((bin) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${bin.ID}</td>
                    <td>${bin.block}, ${bin.level}</td>
                    <td>${bin.cat1_accumulation}%</td>
                    <td>${bin.cat2_accumulation}%</td>
                    <td>${bin.cat3_accumulation}%</td>
                `;
                    table.appendChild(row);
                });
            } else {
                table.innerHTML = "";
                const row = document.createElement("tr");
                row.innerHTML = `<td colspan="5" class="py-3 text-center">No free bin found ...<br><i class="bi bi-trash3 fs-2"></i></td>`;
                table.appendChild(row);
            }
        }

        async function loadFulledBinTable() {
            const response = await fetch("http://localhost:3000/dashboard/loadFulledBinTable");
            const data = await response.json();
            const table = document.getElementById("fulledbin-table");
            if (data.length > 0) {
                table.innerHTML = "";
                data.forEach((bin) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${bin.ID}</td>
                    <td>${bin.block}, ${bin.level}</td>
                    <td>${bin.cat1_accumulation}%</td>
                    <td>${bin.cat2_accumulation}%</td>
                    <td>${bin.cat3_accumulation}%</td>
                `;
                    table.appendChild(row);
                });
            } else {
                table.innerHTML = "";
                const row = document.createElement("tr");
                row.innerHTML = `<td colspan="5" class="py-3 text-center">No fulled bin found ...<br><i class="bi bi-trash3 fs-2"></i></td>`;
                table.appendChild(row);
            }
        }

        async function loadChartContainer() {
            document.getElementById("chart_div").classList.add("justify-content-center");
            document.getElementById("chart_div").classList.remove("justify-content-end");
            document.getElementById("chart_div").innerHTML = `
                                                            <div id="chart_container" class="row w-100">
                                                                <div id="cat1_chart_container" class="col-4"></div>
                                                                <div id="cat2_chart_container" class="col-4"></div>
                                                                <div id="cat3_chart_container" class="col-4"></div>
                                                            </div>
                `;
        }

        async function initializeChart() {
            const response = await fetch("http://localhost:3000/dashboard/initializeChart&Graph");
            const data = await response.json();
            if (data.length > 0) {
                document.getElementById("chart_div").classList.remove("justify-content-center");
                document.getElementById("chart_div").classList.add("justify-content-end");
                let dropdownitem = "";
                data.forEach((bin) => {
                    dropdownitem += `<li><a class="dropdown-item" role="button" data-value="${bin.ID}" onclick="fetchChart(${bin.ID})">Bin ${bin.ID}</a></li>`;
                })
                document.getElementById("chart_div").innerHTML = `
                <div class="dropdown my-3 me-3">
                    <a class="btn btn-secondary dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Select Bin
                    </a>
                    <ul class="dropdown-menu">
                        ${dropdownitem}
                    </ul>
                </div>
                `;
            } else {
                document.getElementById("chart_div").innerHTML = `<p class="text-center mt-3">No bin found ...<br><i class="bi bi-trash3 fs-2"></i></p>`;
            }
        }

        async function initializeGraph() {
            const response = await fetch("http://localhost:3000/dashboard/initializeChart&Graph");
            const data = await response.json();
            if (data.length > 0) {
                document.getElementById("graph_div").classList.remove("justify-content-center");
                document.getElementById("graph_div").classList.add("justify-content-end");
                let dropdownitem = "";
                data.forEach((bin) => {
                    dropdownitem += `<li><a class="dropdown-item" role="button" data-value="${bin.ID}" onclick="fetchGraph(${bin.ID})">Bin ${bin.ID}</a></li>`;
                })
                document.getElementById("graph_div").innerHTML = `
                <div class="dropdown my-3 me-3">
                    <a class="btn btn-secondary dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Select Bin
                    </a>
                    <ul class="dropdown-menu">
                        ${dropdownitem}
                    </ul>
                </div>
                `;
            } else {
                document.getElementById("graph_div").innerHTML = `<p class="text-center mt-3">No bin found ...<br><i class="bi bi-trash3 fs-2"></i></p>`;
            }
        }

        async function fetchChart(binid) {
            const response = await fetch(`http://localhost:3000/dashboard/fetchChart/${binid}`);
            const data = await response.json();
            loadChartContainer();
            const remainingDistance1 = 11.5 * ((100 - (data[0].cat1_accumulation)) / 100);
            const remainingDistance2 = 11.5 * ((100 - (data[0].cat2_accumulation)) / 100);
            const remainingDistance3 = 11.5 * ((100 - (data[0].cat3_accumulation)) / 100);
            drawChart1(remainingDistance1);
            drawChart2(remainingDistance2);
            drawChart3(remainingDistance3);
        }

        async function fetchGraph(binid) {
            const response = await fetch(`http://localhost:3000/dashboard/fetchGraph/${binid}`);
            const data = await response.json();
            document.getElementById("graph_div").classList.add("justify-content-center");
            document.getElementById("graph_div").classList.remove("justify-content-end");
            drawGraph(binid, data);
        }

        async function change(mode) {
            let htmlTag = document.documentElement; // Select the <html> tag
            let logo = document.getElementById("logo");
            let graph = document.getElementById("graph_div");
            let chart = document.getElementById("chart_div");
            let overview = document.getElementById("disposal-overview");

            if (mode == 1) {  // Switch to light mode
                if (htmlTag.getAttribute("data-bs-theme") == "dark") {
                    htmlTag.removeAttribute("data-bs-theme");  // Remove existing theme
                    htmlTag.setAttribute("data-bs-theme", "light");  // Set light mode
                    chart.classList.add("bg-white");
                    graph.classList.add("bg-white");
                    overview.classList.add("bg-white");
                    chart.classList.remove("bg-dark");
                    graph.classList.remove("bg-dark");
                    overview.classList.remove("bg-dark");
                    logo.src = "/smart-trash-dark.svg";
                    document.getElementById("light-theme").classList.add("active");
                    document.getElementById("dark-theme").classList.remove("active");
                    sessionStorage.setItem("theme", "light");
                    document.getElementById("theme-icon").classList.remove("bi-moon");
                    document.getElementById("theme-icon").classList.add("bi-brightness-high");
                }
            } else if (mode == 0) {  // Switch to dark mode
                if (htmlTag.getAttribute("data-bs-theme") == "light") {
                    htmlTag.removeAttribute("data-bs-theme");  // Remove existing theme
                    htmlTag.setAttribute("data-bs-theme", "dark");  // Set dark mode
                    chart.classList.add("bg-dark");
                    graph.classList.add("bg-dark");
                    overview.classList.add("bg-dark");
                    chart.classList.remove("bg-white");
                    graph.classList.remove("bg-white");
                    overview.classList.remove("bg-white");
                    logo.src = "/smart-trash-light.svg";
                    document.getElementById("light-theme").classList.remove("active");
                    document.getElementById("dark-theme").classList.add("active");
                    sessionStorage.setItem("theme", "dark");
                    document.getElementById("theme-icon").classList.remove("bi-brightness-high");
                    document.getElementById("theme-icon").classList.add("bi-moon");
                }
            }
        }

        async function getTheme() {
            const theme = sessionStorage.getItem("theme");
            if (theme == "light") {
                change(1);
            } else if (theme == "dark") {
                change(0);
            }
        }

        socket.on("updateAccumulationPieChart", async (data) => {
            fetchChart(data.binID);
            loadBinsCount();
            loadFreeBinTable();
            loadFulledBinTable();
        });

        socket.on("updateOverviewColumnChart", async () => {
            drawColChart();
        });

        socket.on("updateCollectionFreqGraph", async (data) => {
            const response = await fetch(`http://localhost:3000/dashboard/fetchGraph/${data.binID}`);
            const date = await response.json();
            document.getElementById("graph_div").classList.add("justify-content-center");
            document.getElementById("graph_div").classList.remove("justify-content-end");

            document.getElementById("graph_div").innerHTML = "";
            drawGraph(data.binID, date);
            loadBinsCount();
            loadFreeBinTable();
            loadFulledBinTable();
        });
    </script>
</body>

</html>